const { Pool } = require("pg");
const bcrypt = require("bcryptjs");

let pool;
let schemaPromise;

function getPool() {
  if (pool) return pool;
  if (!process.env.DATABASE_URL) {
    throw new Error("Missing DATABASE_URL");
  }
  pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: { rejectUnauthorized: false }
  });
  return pool;
}

async function query(text, params) {
  const p = getPool();
  return p.query(text, params);
}

async function ensureSchema() {
  if (schemaPromise) return schemaPromise;
  schemaPromise = (async () => {
    await query(
      `
      create table if not exists admins (
        id bigint generated by default as identity primary key,
        username text not null unique,
        password_hash text not null,
        created_at timestamptz not null default now()
      );

      create table if not exists students (
        id bigint generated by default as identity primary key,
        student_no text not null unique,
        name text not null,
        gender text,
        age int,
        class_name text,
        major text,
        phone text,
        email text,
        address text,
        password_hash text not null,
        created_at timestamptz not null default now(),
        updated_at timestamptz not null default now()
      );

      create index if not exists idx_students_student_no on students(student_no);
      create index if not exists idx_students_name on students(name);
      `,
      []
    );

    const adminUsername = "admin";
    const { rowCount } = await query("select 1 from admins where username = $1 limit 1", [adminUsername]);
    if (rowCount === 0) {
      const passwordHash = await bcrypt.hash("admin", 10);
      await query("insert into admins (username, password_hash) values ($1, $2)", [adminUsername, passwordHash]);
    }

    const studentCount = await query("select count(1)::int as c from students", []);
    if ((studentCount.rows[0]?.c || 0) === 0) {
      const defaultPwd = await bcrypt.hash("123456", 10);
      await query(
        `
        insert into students (student_no, name, gender, age, class_name, major, password_hash)
        values
          ('20250001', '张三', '男', 20, '计科1班', '计算机科学与技术', $1),
          ('20250002', '李四', '女', 19, '软工2班', '软件工程', $1),
          ('20250003', '王五', '男', 21, '网工1班', '网络工程', $1)
        `,
        [defaultPwd]
      );
    }
  })();

  return schemaPromise;
}

module.exports = {
  query,
  ensureSchema
};

